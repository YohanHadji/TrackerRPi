
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control JVC + Tracking</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:#111;color:#ddd;margin:0}
    .wrap{display:flex;gap:16px;padding:12px}
    .video{flex:1}
    #video{max-width:100%;border:1px solid #333;background:#000}
    .panel{width:360px;min-width:320px;background:#1a1a1a;border-left:1px solid #333;padding:12px;position:sticky;top:0;height:100vh;overflow:auto}
    .card{background:#151515;border:1px solid #303030;border-radius:10px;padding:10px;margin-bottom:12px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid #444;background:#2a2a2a;color:#eee;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .lbl{opacity:.8}
    input[type=range]{width:160px}
    .joy{width:240px;height:240px;border-radius:120px;border:1px solid #444;position:relative;background:#0f0f0f;margin:8px auto}
    .knob{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:70px;height:70px;border-radius:50%;background:#4448;backdrop-filter:blur(2px)}
    .pill{position:fixed;right:16px;bottom:16px;background:#0008;color:#0f0;padding:10px 12px;border-radius:10px}
  </style>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="video">
      <h2>Video</h2>
      <img id="video" src="/video_feed" alt="Video" onerror="this.onerror=null; this.src='/snapshot?ts='+Date.now()">
    </div>
    <aside class="panel">
      <div class="card">
        <div class="row">
          <button class="btn" id="trackBtn">Tracking ON/OFF</button>
          <label class="lbl"><input type="checkbox" id="flipAz"> flip AZ</label>
          <label class="lbl"><input type="checkbox" id="flipEl"> flip EL</label>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <label class="lbl">Zoom V:</label>
          <input id="zoomRange" type="range" min="0" max="3" step="0.01" value="1.55">
          <span id="zoomVal">1.55 V</span>
        </div>
        <div class="row" style="margin-top:6px;">
          <button class="btn" id="zOut">Z− (hold)</button>
          <label class="lbl">Step</label>
          <input id="zStep" type="range" min="0.02" max="0.50" step="0.01" value="0.10" style="width:120px">
          <span id="zStepVal">0.10 V</span>
          <button class="btn" id="zIn">Z+ (hold)</button>
        </div>
      </div>

      <div class="card">
        <h3>Joystick</h3>
        <div class="joy" id="joy"><div class="knob" id="knob"></div></div>
        <div class="row">
          <label class="lbl">Throttle</label>
          <input id="thr" type="range" min="0.1" max="3.0" step="0.1" value="1.0">
          <label class="lbl"><input type="checkbox" id="trigger" checked> Trigger</label>
        </div>
      </div>

      <div class="card">
        <h3>Calibración</h3>
        <div class="row">
          <label class="lbl">Calib spd (deg/s)</label><input id="calSpd" type="number" step="0.5" value="5">
          <label class="lbl">dur (s)</label><input id="calDur" type="number" step="0.1" value="0.8">
          <button class="btn" id="calBtn">Calibrate</button>
        </div>
      </div>

      <div class="card">
        <h3>Control de seguimiento</h3>
        <div class="row">
          <label>Kp</label><input id="kpSlider" type="range" min="0.02" max="0.6" step="0.01" value="0.28"><span id="kpVal">0.28</span>
        </div>
        <div class="row">
          <label>Max spd</label><input id="maxSpdSlider" type="range" min="1" max="20" step="0.5" value="10"><span id="maxSpdVal">10</span>
        </div>
        <div class="row">
          <label>Offset AZ</label><input id="offAz" type="range" min="-5" max="5" step="0.1" value="0"><span id="offAzVal">0</span>
        </div>
        <div class="row">
          <label>Offset EL</label><input id="offEl" type="range" min="-5" max="5" step="0.1" value="0"><span id="offElVal">0</span>
        </div>
        <div class="row">
          <button class="btn" id="saveCtrl">Save ctrl</button>
        </div>
      </div>
    </aside>
  </div>

  <div class="pill" id="pill">track:OFF</div>

<script>
const NEUTRO = 1.55;
function $(id){ return document.getElementById(id); }

async function GET(u){ const r = await fetch(u); return r.json ? r.json() : r.text(); }
async function POST(u, data){
  const opt = data && data._form
    ? {method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:data._form}
    : {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data||{})};
  const r = await fetch(u,opt); try{ return await r.json(); }catch{ return await r.text(); }
}

function initZoom(){
  const zr = $("zoomRange"), zv=$("zoomVal"), zIn=$("zIn"), zOut=$("zOut"), zStep=$("zStep"), zStepVal=$("zStepVal");
  let to=null;
  function send(v){ POST("/set_zoom", {_form:"voltage="+v.toFixed(2)}); }
  zr.addEventListener("input", ()=>{ zv.textContent = (+zr.value).toFixed(2) + " V"; send(+zr.value); clearTimeout(to); to=setTimeout(()=>send(NEUTRO), 1000); });
  zStep.addEventListener("input", ()=> zStepVal.textContent = (+zStep.value).toFixed(2)+" V");
  function press(dir){ const v = NEUTRO + (dir>0?+1:-1)*parseFloat(zStep.value||"0.10"); send(v); }
  function release(){ send(NEUTRO); }
  ["mousedown","touchstart"].forEach(ev => zIn.addEventListener(ev, (e)=>{e.preventDefault();press(+1)}, {passive:false}));
  ["mouseup","mouseleave","touchend"].forEach(ev => zIn.addEventListener(ev, (e)=>{e.preventDefault();release()}, {passive:false}));
  ["mousedown","touchstart"].forEach(ev => zOut.addEventListener(ev, (e)=>{e.preventDefault();press(-1)}, {passive:false}));
  ["mouseup","mouseleave","touchend"].forEach(ev => zOut.addEventListener(ev, (e)=>{e.preventDefault();release()}, {passive:false}));
}

function initCtrl(){
  const kp=$("kpSlider"), ms=$("maxSpdSlider"), oa=$("offAz"), oe=$("offEl");
  const kv=$("kpVal"), msv=$("maxSpdVal"), oav=$("offAzVal"), oev=$("offElVal");
  ["input","change"].forEach(ev=>kp.addEventListener(ev,()=>kv.textContent=kp.value));
  ["input","change"].forEach(ev=>ms.addEventListener(ev,()=>msv.textContent=ms.value));
  ["input","change"].forEach(ev=>oa.addEventListener(ev,()=>oav.textContent=oa.value));
  ["input","change"].forEach(ev=>oe.addEventListener(ev,()=>oev.textContent=oe.value));
  $("saveCtrl").addEventListener("click", async()=>{
    await POST("/set_ctrl", {kp:+kp.value, max_speed:+ms.value, offset_az:+oa.value, offset_el:+oe.value});
  });
  // cargar prefs
  fetch("/get_prefs").then(r=>r.json()).then(d=>{
    if(d.Kp_deg_per_err!=null){kp.value=d.Kp_deg_per_err; kv.textContent=d.Kp_deg_per_err;}
    if(d.MAX_SPEED_DEG_S!=null){ms.value=d.MAX_SPEED_DEG_S; msv.textContent=d.MAX_SPEED_DEG_S;}
    if(d.OFFSET_AZ!=null){oa.value=d.OFFSET_AZ; oav.textContent=d.OFFSET_AZ;}
    if(d.OFFSET_EL!=null){oe.value=d.OFFSET_EL; oev.textContent=d.OFFSET_EL;}
    if(d.SIGN_AZ!=null){$("flipAz").checked = (d.SIGN_AZ === -1);}
    if(d.SIGN_EL!=null){$("flipEl").checked = (d.SIGN_EL === -1);}
  }).catch(()=>{});
}

function initTrack(){
  $("trackBtn").addEventListener("click", async()=>{
    const t = await POST("/toggle_tracking", {});
    $("pill").textContent = (""+t).includes("ON")? "track:ON":"track:OFF";
  });
  $("flipAz").addEventListener("change", ()=>POST("/set_signs",{flip_az:$("flipAz").checked, flip_el:$("flipEl").checked}));
  $("flipEl").addEventListener("change", ()=>POST("/set_signs",{flip_az:$("flipAz").checked, flip_el:$("flipEl").checked}));
}

function initCalib(){
  $("calBtn").addEventListener("click", async()=>{
    const spd=+$("calSpd").value||5, dur=+$("calDur").value||0.8;
    const r = await fetch("/calibrate",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({spd:spd,dur:dur})});
    try{ const d=await r.json(); alert(JSON.stringify(d)); }catch{ alert("OK"); }
  });
}

// Joystick muy simple
function initJoy(){
  const joy=$("joy"), knob=$("knob"), rect=()=>joy.getBoundingClientRect();
  let down=false;
  function send(x,y){
    const thr = +$("thr").value; const trg = $("trigger").checked?1:0;
    socket.emit("joystick_update", {x:x, y:y, throttle:thr, trigger:trg});
  }
  function handle(clientX, clientY){
    const r = rect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    let dx = (clientX - cx)/(r.width/2);
    let dy = (clientY - cy)/(r.height/2);
    dx = Math.max(-1, Math.min(1, dx));
    dy = Math.max(-1, Math.min(1, dy));
    const unitsX = Math.round(dx*14);
    const unitsY = Math.round(dy*14);
    knob.style.left = (50 + dx*50) + "%";
    knob.style.top  = (50 + dy*50) + "%";
    send(unitsX, unitsY);
  }
  ["mousedown","touchstart"].forEach(ev=>joy.addEventListener(ev, (e)=>{down=true; const t=(e.touches&&e.touches[0])||e; handle(t.clientX,t.clientY);},{passive:false}));
  ["mousemove","touchmove"].forEach(ev=>document.addEventListener(ev, (e)=>{if(!down)return; const t=(e.touches&&e.touches[0])||e; handle(t.clientX,t.clientY);},{passive:false}));
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(ev=>document.addEventListener(ev, (e)=>{ if(!down)return; down=false; knob.style.left='50%'; knob.style.top='50%'; send(0,0); }, {passive:false}));
}

let socket=null;
function initIO(){
  socket = io();
  socket.on("connect", ()=>console.log("IO connected"));
  socket.on("disconnect", ()=>console.log("IO disconnected"));
}

window.addEventListener("load", ()=>{
  initIO(); initZoom(); initCtrl(); initTrack(); initCalib(); initJoy();
});
</script>
</body>
</html>
