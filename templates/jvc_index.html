<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Zoom</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 30px; background: #f0f0f0; }

    /* Imagen de video */
    .video-wrap img { width:100%; max-width: 1000px; border:1px solid #444; display:block; }

    /* Ventana flotante */
    .floating-panel{
      position: fixed; top: 24px; left: 24px;
      width: 340px; max-width: calc(100vw - 40px);
      background: rgba(255,255,255,0.92);
      border: 1px solid #bbb; border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      z-index: 9999; user-select: none; backdrop-filter: blur(4px);
    }
    .panel-header{
      cursor: move; padding: 10px 12px;
      background: #222; color: #fff; font-weight: 600;
      border-top-left-radius: 12px; border-top-right-radius: 12px;
      display:flex; align-items:center; justify-content:space-between;
      touch-action: none;   /* importante para arrastrar en touch */
    }
    .panel-body{ padding: 12px; }

    /* Bloques internos */
    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-weight:600; }

    /* Joystick */
    .joy-wrap{
      width:220px;height:220px;margin:auto;
      border:2px solid #aaa;border-radius:50%;
      position:relative;touch-action:none;user-select:none;background:#fff
    }
    .joy-knob{
      width:60px;height:60px;border-radius:50%;
      background:#ddd;position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%);box-shadow:0 0 8px rgba(0,0,0,.25);
    }

    .slider-container { margin-top: 8px; }
    input[type=range] { width: 100%; }
    .voltage-display { font-size: 1.1em; margin-top: 6px; }
  </style>
</head>
<body>
  <h2>Control de Zoom Analógico JVC</h2>

  <!-- Video -->
  <div class="video-wrap">
    <img src="{{ url_for('video_feed') }}" alt="Video Feed">
  </div>

  <!-- Ventana flotante con controles -->
  <div class="floating-panel" id="controlPanel">
    <div class="panel-header" id="panelHeader">
      Controles
      <span style="opacity:.8;font-size:.9em">arrastra aquí</span>
    </div>
    <div class="panel-body">
      <!-- Joystick -->
      <div class="ctrl" style="align-items:center">
        <div>Joystick</div>
        <div class="joy-wrap" id="joy">
          <div class="joy-knob" id="knob"></div>
        </div>
        <small>X,Y en rango [-14 .. 14]</small>
      </div>

      <!-- Throttle + Trigger -->
      <div class="ctrl" style="margin-top:10px">
        <label for="throttle">Throttle (0.10–30)</label>
        <input id="throttle" type="range" min="0.10" max="30" step="0.01" value="0.10">
        <span id="throttleVal">0.10</span>

        <label style="margin-top:8px;">
          <input type="checkbox" id="trigger"> Trigger
        </label>
      </div>

      <!-- Slider de zoom -->
      <div class="slider-container">
        <label for="zoomSlider">Ajuste de zoom (0.0 - 3.0 V):</label>
        <input type="range" min="0" max="3" value="1.55" step="0.01" id="zoomSlider">
        <div class="voltage-display">
          Tensión actual: <span id="voltageValue">1.55</span> V
        </div>
      </div>

      <!-- Debug XY opcional -->
      <div id="dbg" style="font-family:monospace;margin-top:6px;"></div>
    </div>
    
  </div>

  <!-- Arrastre de ventana (Pointer Events) -->
  <script>
    (function(){
      const panel = document.getElementById('controlPanel');
      const header = document.getElementById('panelHeader');
      let dragging = false, offX = 0, offY = 0;

      header.addEventListener('pointerdown', (e)=>{
        dragging = true;
        header.setPointerCapture(e.pointerId);
        const rect = panel.getBoundingClientRect();
        offX = e.clientX - rect.left;
        offY = e.clientY - rect.top;
      });

      header.addEventListener('pointermove', (e)=>{
        if(!dragging) return;
        let x = e.clientX - offX;
        let y = e.clientY - offY;
        // Limita dentro de la ventana
        x = Math.max(0, Math.min(window.innerWidth  - panel.offsetWidth,  x));
        y = Math.max(0, Math.min(window.innerHeight - panel.offsetHeight, y));
        panel.style.left = x + 'px';
        panel.style.top  = y + 'px';
      });

      const stopDrag = (e)=>{ dragging = false; try{ header.releasePointerCapture(e.pointerId);}catch{} };
      header.addEventListener('pointerup', stopDrag);
      header.addEventListener('pointercancel', stopDrag);
    })();
  </script>

  <!-- Control de Zoom (HTTP) -->
  <script>
    const slider = document.getElementById("zoomSlider");
    const voltageText = document.getElementById("voltageValue");
    let resetTimer = null;
    const NEUTRO = 1.55; // usa 1.50 si tu cámara lo requiere

    slider.addEventListener("input", () => {
      voltageText.textContent = parseFloat(slider.value).toFixed(2);
    });

    slider.addEventListener("change", () => {
      const voltage = parseFloat(slider.value).toFixed(2);
      fetch("/set_zoom", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "voltage=" + voltage
      });

      clearTimeout(resetTimer);
      resetTimer = setTimeout(() => {
        slider.value = NEUTRO;
        voltageText.textContent = NEUTRO.toFixed(2);
        fetch("/set_zoom", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "voltage=" + NEUTRO.toFixed(2)
        });
      }, 1000);
    });
  </script>

  <!-- Joystick (Socket.IO) -->
  <script>
    // Fuerza WebSocket para evitar long-polling
    // PLAN B: forzar long-polling y desactivar upgrade a WebSocket
   const socket = io({
         transports: ["polling"],
         upgrade: false
     });
    socket.on('connect', () => {
    console.log('[socket] conectado (polling). id=', socket.id);
    });
     socket.on('connect_error', (err) => {
     console.log('[socket] connect_error:', err);
    });
     socket.on('disconnect', (reason) => {
     console.log('[socket] disconnect:', reason);
    });

    const joy = document.getElementById('joy');
    const knob = document.getElementById('knob');
    const throttle = document.getElementById('throttle');
    const throttleVal = document.getElementById('throttleVal');
    const trigger = document.getElementById('trigger');
    const dbg = document.getElementById('dbg');

    let center = {x: 0, y: 0}, radius = 0, dragging = false;
    let joyState = {x:0, y:0, throttle: parseFloat(throttle.value), trigger: 0};
    let lastSent = 0;

    const INVERT_Y = true; // cambia a false si tu hardware lo prefiere

    function recomputeGeometry(){
      const r = joy.getBoundingClientRect();
      center.x = r.left + r.width/2;
      center.y = r.top + r.height/2;
      radius = (Math.min(r.width, r.height)/2) - (knob.offsetWidth/2) - 4;
    }
    window.addEventListener('resize', recomputeGeometry);
    window.addEventListener('load', recomputeGeometry);

    function setKnobFromClient(clientX, clientY){
      // Recalcula SIEMPRE por si se movió la ventana
      recomputeGeometry();

      const dx = clientX - center.x;
      const dy = clientY - center.y;
      const dist = Math.hypot(dx, dy);
      const k = dist > radius ? radius/dist : 1;
      const nx = dx * k;
      const ny = dy * k;

      knob.style.left = `calc(50% + ${nx}px)`;
      knob.style.top  = `calc(50% + ${ny}px)`;

      const rawX = 14 * (nx / radius);
      const rawY = 14 * (ny / radius); // +abajo/-arriba
      joyState.x = rawX;
      joyState.y = INVERT_Y ? -rawY : rawY;

      if (dbg) dbg.textContent = `x=${joyState.x.toFixed(2)}  y=${joyState.y.toFixed(2)}`;
    }

    function resetKnob(){
      knob.style.left = '50%';
      knob.style.top  = '50%';
      joyState.x = 0; joyState.y = 0;
      if (dbg) dbg.textContent = `x=0.00  y=0.00`;
    }

    function sendIfDue(){
      const now = performance.now();
      if (now - lastSent >= 50) { // ~20 Hz
        socket.emit('joystick_update', {
          x: joyState.x,
          y: joyState.y,
          throttle: joyState.throttle,
          trigger: joyState.trigger
        });
        lastSent = now;
      }
      if (dragging) requestAnimationFrame(sendIfDue);
    }

    function startDrag(e){
      dragging = true;
      const p = e.touches ? e.touches[0] : e;
      if (e.cancelable) e.preventDefault();
      setKnobFromClient(p.clientX, p.clientY);
      requestAnimationFrame(sendIfDue);
    }
    function moveDrag(e){
      if (!dragging) return;
      const p = e.touches ? e.touches[0] : e;
      if (e.cancelable) e.preventDefault();
      setKnobFromClient(p.clientX, p.clientY);
    }
    function endDrag(e){
      dragging = false;
      if (e && e.cancelable) e.preventDefault();
      resetKnob();
      socket.emit('joystick_update', {
        x: 0, y: 0,
        throttle: joyState.throttle,
        trigger: joyState.trigger
      });
    }

    joy.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup', endDrag);
    joy.addEventListener('touchstart', startDrag, {passive:false});
    joy.addEventListener('touchmove', moveDrag, {passive:false});
    joy.addEventListener('touchend', endDrag, {passive:false});

    throttle.addEventListener('input', () => {
      throttleVal.textContent = throttle.value;
      joyState.throttle = parseFloat(throttle.value);
      socket.emit('joystick_update', {
        x: joyState.x, y: joyState.y,
        throttle: joyState.throttle, trigger: joyState.trigger
      });
    });

    trigger.addEventListener('change', () => {
      joyState.trigger = trigger.checked ? 1 : 0;
      socket.emit('joystick_update', {
        x: joyState.x, y: joyState.y,
        throttle: joyState.throttle, trigger: joyState.trigger
      });
    });
  </script>
</body>
</html>
